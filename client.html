<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #000000; --card-bg: #1c1c1e; --accent: #2481cc; --text: #ffffff; --gray: #8e8e93; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 16px; padding-bottom: 40px; }

        .section-label { color: var(--accent); font-size: 11px; text-transform: uppercase; font-weight: bold; margin: 20px 0 10px 4px; letter-spacing: 0.5px; }
        .header-card { background: var(--card-bg); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .header-card h1 { margin: 0; font-size: 22px; }

        /* –í—ã–±–æ—Ä –ø–∏—Ç–æ–º—Ü–∞ */
        .pet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px; }
        .pet-card { background: var(--card-bg); border-radius: 12px; padding: 12px; text-align: center; border: 2px solid transparent; transition: 0.2s; }
        .pet-card.active { border-color: var(--accent); background: rgba(36, 129, 204, 0.1); }
        .pet-card span { display: block; font-size: 24px; margin-bottom: 4px; }
        .pet-card label { font-size: 13px; font-weight: 500; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        input { width: 100%; background: var(--card-bg); border: none; border-radius: 12px; padding: 14px; font-size: 16px; color: white; margin-bottom: 10px; box-sizing: border-box; outline: none; }

        /* –£—Å–ª—É–≥–∏ */
        .service-list { background: var(--card-bg); border-radius: 12px; padding: 4px; }
        .service-item { padding: 14px; display: flex; justify-content: space-between; border-bottom: 1px solid #2c2c2e; }
        .service-item:last-child { border-bottom: none; }
        .service-item.active { background: rgba(36, 129, 204, 0.1); color: var(--accent); }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .day-cell { padding: 10px 0; border-radius: 8px; font-size: 14px; }
        .day-cell.active { background: var(--accent); color: white; }

        .btn-confirm { width: 100%; background: var(--accent); color: white; border: none; border-radius: 12px; padding: 16px; font-size: 17px; font-weight: bold; margin-top: 24px; }
    </style>
</head>
<body>

    <div class="header-card">
        <span class="section-label" style="margin:0">–°—Ç—É–¥–∏—è</span>
        <h1 id="studio-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
    </div>

    <div class="section-label">–ö—Ç–æ –≤–∞—à –ª—é–±–∏–º–µ—Ü?</div>
    <div class="pet-grid">
        <div class="pet-card" id="pet-dog" onclick="setPet('–°–æ–±–∞–∫–∞', 'pet-dog')"><span>üê∂</span><label>–°–æ–±–∞–∫–∞</label></div>
        <div class="pet-card" id="pet-cat" onclick="setPet('–ö–æ—à–∫–∞', 'pet-cat')"><span>üê±</span><label>–ö–æ—à–∫–∞</label></div>
        <div class="pet-card" id="pet-other" onclick="setPet('–î—Ä—É–≥–æ–π', 'pet-other')"><span>üê∞</span><label>–î—Ä—É–≥–æ–π</label></div>
    </div>

    <input type="text" id="pet-breed" placeholder="–ü–æ—Ä–æ–¥–∞ *">
    <input type="text" id="pet-name" placeholder="–ö–ª–∏—á–∫–∞ *">

    <div class="section-label">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</div>
    <div class="service-list" id="services-container">
        <div style="padding:15px; color:#666">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–∞...</div>
    </div>

    <div class="section-label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
    <input type="tel" id="client-phone" placeholder="+7 (___) ___-__-__ *">

    <div class="section-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</div>
    <div class="header-card" style="padding: 10px;">
        <div class="calendar-nav">
            <span style="color:var(--accent)">‚ùÆ</span>
            <b id="month-name">–Ø–Ω–≤–∞—Ä—å 2026</b>
            <span style="color:var(--accent)">‚ùØ</span>
        </div>
        <div class="days-grid" id="days-container"></div>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:15px;" id="time-container"></div>
    </div>

    <button class="btn-confirm" onclick="submitBooking()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>

    <script>
        const tg = window.Telegram.WebApp;
        const _sb = supabase.createClient('https://uplcrgnxkafcxejwuggx.supabase.co', 'sb_publishable_SDlNlU_Nco34DHqTS0DasA_5jQqyiSF');
        const mId = new URLSearchParams(window.location.search).get('master');

        let booking = { type: "", service: "", date: "", time: "", master_id: mId };

        async function init() {
            tg.ready(); tg.expand();
            if (!mId) { document.getElementById('studio-title').innerText = "–ú–∞—Å—Ç–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω"; return; }

            const { data: m } = await _sb.from('masters').select('studio_name').eq('telegram_id', Number(mId)).single();
            if (m) document.getElementById('studio-title').innerText = m.studio_name;

            const { data: srv } = await _sb.from('services').select('*').eq('master_id', Number(mId));
            const container = document.getElementById('services-container');
            container.innerHTML = "";
            srv?.forEach(s => {
                const item = document.createElement('div');
                item.className = 'service-item';
                item.innerHTML = `<span>${s.name}</span><b>${s.price} ‚Ç∏</b>`;
                item.onclick = () => {
                    document.querySelectorAll('.service-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                    booking.service = s.name;
                };
                container.appendChild(item);
            });
            renderCalendar();
        }

        function setPet(type, id) {
            document.querySelectorAll('.pet-card').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            booking.type = type;
        }

        function renderCalendar() {
            const cont = document.getElementById('days-container');
            const today = new Date();
            for(let i=0; i<7; i++) {
                let d = new Date(); d.setDate(today.getDate() + i);
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.innerHTML = `${d.getDate()}<br><small style="font-size:10px">${d.toLocaleDateString('ru-RU', {weekday:'short'})}</small>`;
                cell.onclick = () => {
                    document.querySelectorAll('.day-cell').forEach(e => e.classList.remove('active'));
                    cell.classList.add('active');
                    booking.date = d.toLocaleDateString('ru-RU');
                    renderTimes();
                };
                cont.appendChild(cell);
            }
        }

        function renderTimes() {
            const cont = document.getElementById('time-container');
            cont.innerHTML = "";
            ["10:00", "12:00", "14:00", "16:00", "18:00"].forEach(t => {
                const slot = document.createElement('div');
                slot.className = 'pet-card'; // –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
                slot.innerText = t;
                slot.onclick = () => {
                    document.querySelectorAll('#time-container .pet-card').forEach(e => e.classList.remove('active'));
                    slot.classList.add('active');
                    booking.time = t;
                };
                cont.appendChild(slot);
            });
        }

        function submitBooking() {
            const breed = document.getElementById('pet-breed').value;
            const name = document.getElementById('pet-name').value;
            const phone = document.getElementById('client-phone').value;

            if (!booking.type || !booking.service || !booking.date || !booking.time || !phone) {
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Å–æ –∑–≤–µ–∑–¥–æ—á–∫–æ–π!");
                return;
            }

            tg.sendData(JSON.stringify({
                ...booking,
                pet_type: booking.type,
                breed: breed,
                pet_name: name,
                phone: phone
            }));
            tg.close();
        }

        init();
    </script>
</body>
</html>