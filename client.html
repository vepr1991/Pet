<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Оставляем ваши стили из предыдущего сообщения (pet-grid, service-cat и т.д.) */
        :root { --bg-color: #ffffff; --text-color: #000000; --button-color: #2481cc; --secondary-bg: #f0f0f0; }
        body { font-family: sans-serif; background-color: #000; color: white; padding: 12px; }
        .section { background: #1c1c1e; border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        .label { font-size: 13px; font-weight: bold; color: var(--button-color); text-transform: uppercase; margin-bottom: 10px; display: block; }
        input { width: 100%; background: #2c2c2e; border: none; border-radius: 10px; padding: 14px; font-size: 17px; color: white; margin-bottom: 8px; box-sizing: border-box; }
        .service-item { background: #2c2c2e; padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; border: 2px solid transparent; }
        .service-item.active { border-color: var(--button-color); }
        /* ... (другие ваши стили календаря) */
    </style>
</head>
<body>
    <div class="section">
        <span class="label">Вы записываетесь в студию:</span>
        <h2 id="studio-name">Загрузка...</h2>
    </div>

    <div class="section">
        <span class="label">Выберите услугу</span>
        <div id="services-list">Загрузка прайса...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const urlParams = new URLSearchParams(window.location.search);
        const masterId = urlParams.get('master'); // Получаем ID мастера из URL

        const _supabase = supabase.createClient('https://uplcrgnxkafcxejwuggx.supabase.co', 'sb_publishable_SDlNlU_Nco34DHqTS0DasA_5jQqyiSF');

        async function loadStudio() {
            if (!masterId) {
                document.getElementById('studio-name').innerText = "Общий выбор";
                return;
            }

            // Загружаем имя студии
            const { data: master } = await _supabase.from('masters').select('studio_name').eq('telegram_id', masterId).single();
            if (master) document.getElementById('studio-name').innerText = master.studio_name;

            // Загружаем услуги именно этого мастера
            const { data: services } = await _supabase.from('services').select('*').eq('master_id', masterId);
            const list = document.getElementById('services-list');
            list.innerHTML = '';

            if (services && services.length > 0) {
                services.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'service-item';
                    div.innerText = `${s.name} — ${s.price} ₸`;
                    div.onclick = () => {
                        document.querySelectorAll('.service-item').forEach(i => i.classList.remove('active'));
                        div.classList.add('active');
                        form.service = s.name;
                        validate();
                    };
                    list.appendChild(div);
                });
            } else {
                list.innerText = "Услуги еще не добавлены";
            }
        }

        // В функции tg.MainButton.onClick обязательно добавьте master_id:
        tg.MainButton.onClick(() => {
            tg.sendData(JSON.stringify({
                action: "client_appointment",
                master_id: masterId,
                pet_name: document.getElementById('pet_name').value,
                service: form.service,
                phone: document.getElementById('phone').value,
                date_time: form.dateStr + " в " + form.time
                // ... остальные поля
            }));
        });

        loadStudio();
    </script>
</body>
</html>