<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #1c1c1e; --accent: #2481cc; --text: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: #000; color: var(--text); margin: 0; padding: 20px; }
        .studio-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: var(--accent); }
        .service-card { background: #1c1c1e; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-book { background: var(--accent); color: white; border: none; border-radius: 10px; padding: 10px 20px; font-weight: bold; cursor: pointer; }
        #loader { text-align: center; margin-top: 50px; }
        .price { color: var(--accent); font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>
    <div id="main-content" style="display:none;">
        <div id="master-title" class="studio-name">–°—Ç—É–¥–∏—è</div>
        <p style="color: #888; margin-bottom: 25px;">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –¥–ª—è –∑–∞–ø–∏—Å–∏:</p>
        <div id="services-list"></div>
    </div>
    <div id="loader">üêæ –ò—â–µ–º –º–∞—Å—Ç–µ—Ä–∞ –∏ —É—Å–ª—É–≥–∏...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const _sb = supabase.createClient('https://uplcrgnxkafcxejwuggx.supabase.co', 'sb_publishable_SDlNlU_Nco34DHqTS0DasA_5jQqyiSF');

        const params = new URLSearchParams(window.location.search);
        const mId = params.get('master');

        async function init() {
            if (!mId) {
                document.getElementById('loader').innerText = "–û—à–∏–±–∫–∞: –ú–∞—Å—Ç–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω –≤ —Å—Å—ã–ª–∫–µ.";
                return;
            }

            try {
                // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º Number(mId) –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–∏–ø—É –≤ –ë–î
                const numericId = Number(mId);

                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Å—Ç–µ—Ä–µ
                const { data: master, error: mErr } = await _sb.from('masters')
                    .select('studio_name')
                    .eq('telegram_id', numericId)
                    .single();

                if (master) {
                    document.getElementById('master-title').innerText = master.studio_name;
                }

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–∞
                const { data: services, error: sErr } = await _sb.from('services')
                    .select('*')
                    .eq('master_id', numericId);

                const list = document.getElementById('services-list');
                list.innerHTML = "";

                if (services && services.length > 0) {
                    services.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'service-card';
                        div.innerHTML = `
                            <div><b>${s.name}</b><br><span class="price">${s.price} ‚Ç∏</span></div>
                            <button class="btn-book" onclick="startBooking('${s.name}')">–í—ã–±—Ä–∞—Ç—å</button>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = "<p style='color:#666; text-align:center;'>–£ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å–ª—É–≥ –≤ –ø—Ä–∞–π—Å–µ.</p>";
                }

                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.";
            }
        }

        function startBooking(serviceName) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç
            tg.sendData(JSON.stringify({
                action: "book",
                service: serviceName,
                master_id: mId
            }));
            tg.close();
        }

        init();
    </script>
</body>
</html>