<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #1c1c1e; --accent: #2481cc; --gray: #2c2c2e; --text: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: #000; color: var(--text); margin: 0; padding: 15px; }
        .section { background: var(--bg); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .label { font-size: 12px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; display: block; }
        input { width: 100%; background: var(--gray); border: none; border-radius: 10px; padding: 15px; font-size: 16px; color: #fff; margin-bottom: 10px; box-sizing: border-box; }

        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .item { background: var(--gray); padding: 12px; border-radius: 12px; text-align: center; border: 2px solid transparent; }
        .item.active { border-color: var(--accent); background: rgba(36, 129, 204, 0.1); }

        .service-card { background: var(--gray); padding: 15px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; border: 2px solid transparent; }
        .service-card.active { border-color: var(--accent); }

        .cal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day { padding: 10px 0; border-radius: 8px; background: var(--gray); font-size: 14px; }
        .day.act { background: var(--accent); }
        .day.dis { opacity: 0.2; }
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .time { background: var(--gray); padding: 10px 0; border-radius: 8px; text-align: center; }
        .time.act { background: var(--accent); }
    </style>
</head>
<body>

    <div class="section">
        <span class="label">–°—Ç—É–¥–∏—è</span>
        <h2 id="st-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
    </div>

    <div class="section">
        <span class="label">–ü–∏—Ç–æ–º–µ—Ü</span>
        <div class="grid">
            <div class="item" id="p1" onclick="setPet('–°–æ–±–∞–∫–∞', 'p1')">üê∂<br>–°–æ–±–∞–∫–∞</div>
            <div class="item" id="p2" onclick="setPet('–ö–æ—à–∫–∞', 'p2')">üê±<br>–ö–æ—à–∫–∞</div>
            <div class="item" id="p3" onclick="setPet('–î—Ä—É–≥–æ–π', 'p3')">üê∞<br>–î—Ä—É–≥–æ–π</div>
        </div>
        <input type="text" id="breed" placeholder="–ü–æ—Ä–æ–¥–∞ *" style="margin-top:15px">
        <input type="text" id="pname" placeholder="–ö–ª–∏—á–∫–∞ *">
    </div>

    <div class="section">
        <span class="label">–£—Å–ª—É–≥–∏</span>
        <div id="srv-list">–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –º–∞—Å—Ç–µ—Ä–∞...</div>
    </div>

    <div class="section">
        <span class="label">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≤—Ä–µ–º—è</span>
        <input type="tel" id="phone" placeholder="+7 (___) ___-__-__">

        <div class="cal-header">
            <button onclick="moveMonth(-1)" style="background:none; border:none; color:#2481cc; font-size:20px">‚Äπ</button>
            <b id="m-name"></b>
            <button onclick="moveMonth(1)" style="background:none; border:none; color:#2481cc; font-size:20px">‚Ä∫</button>
        </div>
        <div class="cal-grid" id="cal-body"></div>
        <div class="time-grid" id="tm-body"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const params = new URLSearchParams(location.search);
        const mId = params.get('master');
        const _sb = supabase.createClient('https://uplcrgnxkafcxejwuggx.supabase.co', 'sb_publishable_SDlNlU_Nco34DHqTS0DasA_5jQqyiSF');

        let sel = { pet:'', srv:'', date:'', time:'', m: new Date().getMonth(), y: new Date().getFullYear() };

        async function init() {
            if (!mId) { document.getElementById('st-name').innerText = "–û—à–∏–±–∫–∞: ID –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"; return; }

            const { data: m } = await _sb.from('masters').select('studio_name').eq('telegram_id', mId).single();
            if (m) document.getElementById('st-name').innerText = m.studio_name;

            const { data: s } = await _sb.from('services').select('*').eq('master_id', mId);
            const list = document.getElementById('srv-list');
            list.innerHTML = '';
            s?.forEach(i => {
                const d = document.createElement('div');
                d.className = 'service-card';
                d.innerHTML = `<span>${i.name}</span><b>${i.price} ‚Ç∏</b>`;
                d.onclick = () => {
                    document.querySelectorAll('.service-card').forEach(x => x.classList.remove('active'));
                    d.classList.add('active'); sel.srv = i.name; check();
                };
                list.appendChild(d);
            });
            renderCal();
        }

        function setPet(v, id) {
            document.querySelectorAll('.item').forEach(x => x.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            sel.pet = v; check();
        }

        function moveMonth(v) {
            sel.m += v;
            if (sel.m > 11) { sel.m = 0; sel.y++; }
            if (sel.m < 0) { sel.m = 11; sel.y--; }
            renderCal();
        }

        function renderCal() {
            const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
            document.getElementById('m-name').innerText = months[sel.m] + " " + sel.y;
            const body = document.getElementById('cal-body');
            body.innerHTML = '';

            const days = new Date(sel.y, sel.m + 1, 0).getDate();
            for(let i=1; i<=days; i++) {
                const d = document.createElement('div');
                d.className = 'day';
                d.innerText = i;
                d.onclick = () => {
                    document.querySelectorAll('.day').forEach(x => x.classList.remove('act'));
                    d.classList.add('act'); sel.date = `${i}.${sel.m+1}.${sel.y}`;
                    renderTime(); check();
                };
                body.appendChild(d);
            }
        }

        function renderTime() {
            const b = document.getElementById('tm-body'); b.innerHTML = '';
            [10,11,12,13,14,15,16,17,18].forEach(h => {
                const t = document.createElement('div'); t.className = 'time'; t.innerText = h+':00';
                t.onclick = () => {
                    document.querySelectorAll('.time').forEach(x => x.classList.remove('act'));
                    t.classList.add('act'); sel.time = h+':00'; check();
                };
                b.appendChild(t);
            });
        }

        document.getElementById('phone').oninput = (e) => {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
            e.target.value = !x[2] ? x[1] : '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
            check();
        };

        function check() {
            const ok = sel.pet && sel.srv && sel.date && sel.time && document.getElementById('phone').value.length > 17;
            if (ok) { tg.MainButton.show(); tg.MainButton.setText("–ó–∞–ø–∏—Å–∞—Ç—å—Å—è"); } else tg.MainButton.hide();
        }

        tg.MainButton.onClick(() => {
            tg.sendData(JSON.stringify({
                action: "client_appointment",
                master_id: mId,
                pet_type: sel.pet,
                breed: document.getElementById('breed').value,
                pet_name: document.getElementById('pname').value,
                service: sel.srv,
                phone: document.getElementById('phone').value,
                date_time: sel.date + " –≤ " + sel.time
            }));
        });

        init();
    </script>
</body>
</html>