<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #1c1c1e; --accent: #2481cc; --gray: #2c2c2e; --text: #ffffff; --hint: #666; }
        body { font-family: -apple-system, sans-serif; background: #000; color: var(--text); margin: 0; padding: 15px; -webkit-user-select: none; }
        .section { background: var(--bg); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .label { font-size: 12px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin-bottom: 12px; display: block; }
        input { width: 100%; background: var(--gray); border: none; border-radius: 10px; padding: 15px; font-size: 16px; color: #fff; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .item { background: var(--gray); padding: 12px; border-radius: 12px; text-align: center; border: 2px solid transparent; cursor: pointer; }
        .item.active { border-color: var(--accent); background: rgba(36, 129, 204, 0.1); }
        .item span { font-size: 24px; display: block; margin-bottom: 4px; }
        .service-card { background: var(--gray); padding: 15px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 2px solid transparent; cursor: pointer; }
        .service-card.active { border-color: var(--accent); background: rgba(36, 129, 204, 0.1); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; padding: 5px 0 15px 0; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-header { font-size: 10px; color: var(--hint); text-transform: uppercase; padding-bottom: 8px; }
        .day { padding: 10px 0; border-radius: 8px; background: var(--gray); font-size: 14px; cursor: pointer; }
        .day.act { background: var(--accent); color: white; font-weight: bold; }
        .day.dis { opacity: 0.15; pointer-events: none; }
        .empty { padding: 10px 0; }
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .time { background: var(--gray); padding: 12px 0; border-radius: 8px; text-align: center; cursor: pointer; font-size: 14px; }
        .time.act { background: var(--accent); color: white; }
        #loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; display:flex; justify-content:center; align-items:center; z-index:100; }
    </style>
</head>
<body>

    <div id="loader-overlay">üêæ –ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="section">
        <span class="label">–°—Ç—É–¥–∏—è</span>
        <h2 id="st-name" style="margin:0">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
    </div>

    <div class="section">
        <span class="label">–ö—Ç–æ –≤–∞—à –ª—é–±–∏–º–µ—Ü?</span>
        <div class="grid">
            <div class="item" id="p1" onclick="setPet('–°–æ–±–∞–∫–∞', 'p1')"><span>üê∂</span>–°–æ–±–∞–∫–∞</div>
            <div class="item" id="p2" onclick="setPet('–ö–æ—à–∫–∞', 'p2')"><span>üê±</span>–ö–æ—à–∫–∞</div>
            <div class="item" id="p3" onclick="setPet('–î—Ä—É–≥–æ–π', 'p3')"><span>üê∞</span>–î—Ä—É–≥–æ–π</div>
        </div>
        <input type="text" id="breed" placeholder="–ü–æ—Ä–æ–¥–∞ *" style="margin-top:15px" oninput="check()">
        <input type="text" id="pname" placeholder="–ö–ª–∏—á–∫–∞ *" oninput="check()">
    </div>

    <div class="section">
        <span class="label">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</span>
        <div id="srv-list"></div>
    </div>

    <div class="section">
        <span class="label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
        <input type="tel" id="phone" placeholder="+7 (___) ___-__-__ *">

        <span class="label" style="margin-top:20px">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</span>
        <div class="cal-header">
            <button onclick="moveMonth(-1)" style="background:none; border:none; color:var(--accent); font-size:28px">‚Äπ</button>
            <b id="m-name"></b>
            <button onclick="moveMonth(1)" style="background:none; border:none; color:var(--accent); font-size:28px">‚Ä∫</button>
        </div>
        <div class="cal-grid" id="cal-body"></div>
        <div id="tm-body" class="time-grid"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const params = new URLSearchParams(location.search);
        const mId = params.get('master');
        const _sb = supabase.createClient('https://uplcrgnxkafcxejwuggx.supabase.co', 'sb_publishable_SDlNlU_Nco34DHqTS0DasA_5jQqyiSF');

        let sel = { pet:'', srv:'', date:'', time:'', m: new Date().getMonth(), y: new Date().getFullYear() };
        const now = new Date();

        async function init() {
            try {
                if (!mId) {
                    document.getElementById('st-name').innerText = "–ú–∞—Å—Ç–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω";
                    document.getElementById('srv-list').innerHTML = "<p style='color:#666'>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –º–∞—Å—Ç–µ—Ä–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏.</p>";
                } else {
                    const { data: m } = await _sb.from('masters').select('studio_name').eq('telegram_id', mId).single();
                    if (m) document.getElementById('st-name').innerText = m.studio_name;

                    const { data: s } = await _sb.from('services').select('*').eq('master_id', mId);
                    const list = document.getElementById('srv-list');
                    if (s && s.length > 0) {
                        s.forEach(i => {
                            const d = document.createElement('div');
                            d.className = 'service-card';
                            d.innerHTML = `<span>${i.name}</span><b>${i.price} ‚Ç∏</b>`;
                            d.onclick = () => {
                                document.querySelectorAll('.service-card').forEach(x => x.classList.remove('active'));
                                d.classList.add('active'); sel.srv = i.name; check();
                            };
                            list.appendChild(d);
                        });
                    } else {
                        list.innerHTML = "<p style='color:#666'>–£ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ–∫–∞ –Ω–µ—Ç —É—Å–ª—É–≥.</p>";
                    }
                }
                document.getElementById('loader-overlay').style.display = 'none';
                renderCal();
            } catch (e) { console.error(e); }
        }

        function setPet(v, id) {
            document.querySelectorAll('.item').forEach(x => x.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            sel.pet = v; check();
        }

        function moveMonth(v) {
            let next = new Date(sel.y, sel.m + v, 1);
            if (next < new Date(now.getFullYear(), now.getMonth(), 1)) return;
            sel.m = next.getMonth(); sel.y = next.getFullYear();
            renderCal();
        }

        function renderCal() {
            const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
            document.getElementById('m-name').innerText = months[sel.m] + " " + sel.y;
            const body = document.getElementById('cal-body');
            body.innerHTML = '<div class="day-header">–ü–Ω</div><div class="day-header">–í—Ç</div><div class="day-header">–°—Ä</div><div class="day-header">–ß—Ç</div><div class="day-header">–ü—Ç</div><div class="day-header">–°–±</div><div class="day-header">–í—Å</div>';

            let firstDay = new Date(sel.y, sel.m, 1).getDay();
            if (firstDay === 0) firstDay = 7;
            const daysInMonth = new Date(sel.y, sel.m + 1, 0).getDate();

            for (let i = 1; i < firstDay; i++) {
                const e = document.createElement('div'); e.className = 'empty'; body.appendChild(e);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const d = document.createElement('div');
                d.className = 'day';
                const dObj = new Date(sel.y, sel.m, i);
                if (dObj < new Date(now.getFullYear(), now.getMonth(), now.getDate())) d.classList.add('dis');
                d.innerText = i;
                d.onclick = () => {
                    document.querySelectorAll('.day').forEach(x => x.classList.remove('act'));
                    d.classList.add('act');
                    sel.date = `${i.toString().padStart(2,'0')}.${(sel.m+1).toString().padStart(2,'0')}.${sel.y}`;
                    renderTime(i); check();
                };
                body.appendChild(d);
            }
        }

        function renderTime(day) {
            const b = document.getElementById('tm-body'); b.innerHTML = '';
            [10,11,12,13,14,15,16,17,18,19].forEach(h => {
                const t = document.createElement('div'); t.className = 'time';
                if (sel.y === now.getFullYear() && sel.m === now.getMonth() && day === now.getDate() && h <= now.getHours()) t.style.opacity = '0.2';
                t.innerText = h + ':00';
                t.onclick = () => {
                    document.querySelectorAll('.time').forEach(x => x.classList.remove('act'));
                    t.classList.add('act'); sel.time = h + ':00'; check();
                };
                b.appendChild(t);
            });
        }

        document.getElementById('phone').oninput = (e) => {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
            e.target.value = !x[2] ? x[1] : '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
            check();
        };

        function check() {
            const ok = sel.pet && sel.srv && sel.date && sel.time && document.getElementById('phone').value.length >= 18 && document.getElementById('breed').value && document.getElementById('pname').value;
            if (ok) { tg.MainButton.show(); tg.MainButton.setText("–ó–∞–ø–∏—Å–∞—Ç—å—Å—è"); } else tg.MainButton.hide();
        }

        tg.MainButton.onClick(() => {
            tg.sendData(JSON.stringify({
                action: "client_appointment",
                master_id: mId,
                pet_type: sel.pet,
                breed: document.getElementById('breed').value,
                pet_name: document.getElementById('pname').value,
                service: sel.srv,
                phone: document.getElementById('phone').value,
                date_time: sel.date + " –≤ " + sel.time
            }));
        });
        init();
    </script>
</body>
</html>