<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
:root {
  --bg: #1c1c1e;
  --surface: #2c2c2e;
  --accent: #2481cc;
  --text: #ffffff;
  --text-secondary: #9a9a9e;
  --red: #ff3b30;
}

/* Base */
body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
  background: #000;
  color: var(--text);
  margin: 0;
  padding: 14px;
  -webkit-tap-highlight-color: transparent;
}

/* Loader */
#loader {
  position: fixed;
  inset: 0;
  background: #000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 100;
}

.spinner {
  width: 28px;
  height: 28px;
  border: 2.5px solid #333;
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Header & Tabs */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}

.tab-menu {
  display: flex;
  gap: 6px;
  margin-bottom: 18px;
  background: var(--bg);
  padding: 4px;
  border-radius: 10px;
}

.tab {
  flex: 1;
  padding: 8px 0;
  text-align: center;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text-secondary);
  transition: background 0.2s ease, color 0.2s ease;
}

.tab.active {
  background: var(--surface);
  color: var(--text);
  font-weight: 600;
}

/* Sections */
.section { display: none; }
.section.active { display: block; }

/* Cards */
.card {
  background: var(--bg);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}

.label {
  font-size: 11px;
  color: var(--accent);
  text-transform: uppercase;
  margin-bottom: 8px;
  display: block;
  font-weight: 600;
  letter-spacing: 0.4px;
}

/* Inputs */
input {
  width: 100%;
  background: var(--surface);
  border: 1px solid transparent;
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 15px;
  color: var(--text);
  margin-bottom: 10px;
  outline: none;
  transition: border-color 0.2s ease, background 0.2s ease;
}

input::placeholder {
  color: var(--text-secondary);
}

input:focus {
  border-color: var(--accent);
  background: #333;
}

/* Buttons */
.btn {
  width: 100%;
  height: 44px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: opacity 0.15s ease, transform 0.05s ease;
}

.btn:active {
  opacity: 0.85;
  transform: scale(0.98);
}

/* Services List */
.service-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--surface);
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 8px;
}

.service-info b {
  display: block;
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 2px;
}

.service-info small {
  color: var(--accent);
  font-size: 13px;
}

.del-btn {
  background: rgba(255, 59, 48, 0.12);
  color: var(--red);
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 16px;
  cursor: pointer;
}

/* Appointments */
.appt-card {
  border-left: 3px solid var(--accent);
}

.appt-time {
  font-weight: 600;
  color: var(--accent);
  font-size: 15px;
  margin-bottom: 4px;
}

.appt-pet {
  font-size: 16px;
  margin-bottom: 2px;
}

.appt-service {
  color: var(--text-secondary);
  font-size: 13px;
  margin-bottom: 10px;
}

.call-link {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
}
</style>

</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
    </div>

    <div class="header">
        <div>
            <h2 id="studio-name" style="margin:0; font-size: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <div id="master-id-badge" style="font-size:10px; color:#555; margin-top:2px"></div>
        </div>
        <button onclick="location.reload()" style="background:none; border:none; font-size:20px; cursor:pointer">üîÑ</button>
    </div>

    <div class="tab-menu">
        <div class="tab active" onclick="showTab('tab-appts', this)">–ó–∞–ø–∏—Å–∏</div>
        <div class="tab" onclick="showTab('tab-services', this)">–£—Å–ª—É–≥–∏</div>
        <div class="tab" onclick="showTab('tab-settings', this)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>

    <div id="tab-appts" class="section active">
        <div id="appts-list"></div>
    </div>

    <div id="tab-services" class="section">
        <div class="card">
            <span class="label">–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞</span>
            <input type="text" id="srv-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –°—Ç—Ä–∏–∂–∫–∞)">
            <input type="number" id="srv-price" placeholder="–¶–µ–Ω–∞ (‚Ç∏)">
            <button class="btn" onclick="addService()">–î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–∞–π—Å</button>
        </div>
        <div id="services-list"></div>
    </div>

    <div id="tab-settings" class="section">
        <div class="card">
            <span class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Å—Ç—É–¥–∏–∏</span>
            <input type="text" id="edit-studio-name">
            <button class="btn" onclick="updateStudio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
        </div>
        <div style="text-align: center; color: #444; font-size: 11px; margin-top: 20px;">
            PETGroom Admin Panel v1.0.8<br>Powered by Supabase & Telegram
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        // Supabase
        const _sb = supabase.createClient('https://uplcrgnxkafcxejwuggx.supabase.co', 'sb_publishable_SDlNlU_Nco34DHqTS0DasA_5jQqyiSF');

        // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –ü–û–õ–£–ß–ï–ù–ò–ï ID
        const params = new URLSearchParams(window.location.search);
        let mId = params.get('master') || tg.initDataUnsafe.user?.id;

        async function init() {
            if (!mId) {
                document.getElementById('loader').innerHTML = `
                    <div style="text-align:center; padding:30px;">
                        <p style="font-size:40px">üîí</p>
                        <p>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
                        <p style="font-size:12px; color:#666; margin-bottom:20px">ID –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ.</p>
                        <button class="btn" onclick="tg.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>`;
                return;
            }

            document.getElementById('master-id-badge').innerText = "MASTER ID: " + mId;

            try {
                // –ï—Å–ª–∏ –±–∞–∑–∞ –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞, –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –Ω–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç—Ç–æ
                await loadMaster();
                await loadServices();
                await loadAppts();
                document.getElementById('loader').style.display = 'none';
            } catch (e) {
                console.error(e);
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function loadMaster() {
            const { data } = await _sb.from('masters').select('*').eq('telegram_id', mId).single();
            if (data) {
                document.getElementById('studio-name').innerText = data.studio_name;
                document.getElementById('edit-studio-name').value = data.studio_name;
            } else {
                document.getElementById('studio-name').innerText = "–°—Ç—É–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞";
            }
        }

        async function loadServices() {
            const { data } = await _sb.from('services').select('*').eq('master_id', mId).order('id', { ascending: false });
            const list = document.getElementById('services-list');
            list.innerHTML = data?.length ? '<span class="label">–í–∞—à –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–∞–π—Å</span>' : '<p style="color:#666; text-align:center">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É—Å–ª—É–≥. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
            data?.forEach(s => {
                const div = document.createElement('div');
                div.className = 'service-item';
                div.innerHTML = `<div class="service-info"><b>${s.name}</b><small>${s.price} ‚Ç∏</small></div>
                                 <button class="del-btn" onclick="delService(${s.id})">üóëÔ∏è</button>`;
                list.appendChild(div);
            });
        }

async function addService() {
    const name = document.getElementById('srv-name').value;
    const price = document.getElementById('srv-price').value;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
    if (!name || !price) {
        tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É!");
        return;
    }

    // –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º mId –∫–∞–∫ Number, —á—Ç–æ–±—ã –±–∞–∑–∞ –µ–≥–æ –ø—Ä–∏–Ω—è–ª–∞
    const { error } = await _sb.from('services').insert([
        {
            master_id: Number(mId),
            name: name,
            price: parseInt(price)
        }
    ]);

    if (!error) {
        document.getElementById('srv-name').value = '';
        document.getElementById('srv-price').value = '';
        tg.showScanQrPopup && tg.showAlert("–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ"); // –ú–∞–ª–µ–Ω—å–∫–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        loadServices();
    } else {
        console.error("–û—à–∏–±–∫–∞ Supabase:", error);
        tg.showAlert("–û—à–∏–±–∫–∞: " + error.message);
    }
}

function delService(id) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ Telegram WebApp
    tg.showConfirm("–£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É –∏–∑ –ø—Ä–∞–π—Å–∞?", (isConfirmed) => {
        if (isConfirmed) {
            // –ï—Å–ª–∏ –º–∞—Å—Ç–µ—Ä –Ω–∞–∂–∞–ª "–û–ö", –≤—ã–ø–æ–ª–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
            executeDelete(id);
        }
    });
}

// –í—ã–Ω–µ—Å–µ–º —Å–∞–º–æ —É–¥–∞–ª–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∫–æ–¥–∞
async function executeDelete(id) {
    try {
        const { error } = await _sb.from('services').delete().eq('id', id);
        if (!error) {
            loadServices(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            tg.showScanQrPopup && tg.showAlert("–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞");
        } else {
            tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: " + error.message);
        }
    } catch (e) {
        console.error(e);
    }
}

        async function loadAppts() {
            const { data } = await _sb.from('appointments').select('*').eq('master_id', mId).order('id', { ascending: false });
            const list = document.getElementById('appts-list');
            list.innerHTML = '';

            if (!data || data.length === 0) {
                list.innerHTML = '<div class="card" style="text-align:center; color:#666">–ù–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.<br><br><small>–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–Ω—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è, –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</small></div>';
                return;
            }

            data.forEach(a => {
                const div = document.createElement('div');
                div.className = 'card appt-card';
                div.innerHTML = `
                    <div class="appt-time">${a.date_time}</div>
                    <div class="appt-pet"><b>${a.breed}</b> ${a.pet_name}</div>
                    <div class="appt-service">${a.service}</div>
                    <a href="tel:${a.phone}" class="call-link">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</a>
                `;
                list.appendChild(div);
            });
        }

        async function updateStudio() {
            const val = document.getElementById('edit-studio-name').value;
            if (!val) return;
            const { error } = await _sb.from('masters').update({ studio_name: val }).eq('telegram_id', mId);
            if (!error) {
                tg.showAlert("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
                document.getElementById('studio-name').innerText = val;
            }
        }

        function showTab(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        init();
    </script>
</body>
</html>