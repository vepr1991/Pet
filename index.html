<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #000; color: white; text-align: center; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; justify-content: center; height: 100vh; margin: 0; }
        .btn { width: 85%; padding: 20px; margin: 10px auto; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .client { background: #2481cc; color: white; }
        .master { background: transparent; border: 2px solid #2481cc; color: #2481cc; }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        #loader { font-size: 16px; color: #999; }
        #menu { display: none; }
    </style>
</head>
<body>
    <div id="loader">
        <div style="margin-bottom: 10px;">üêæ</div>
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...
    </div>

    <div id="menu">
        <h2 style="margin-bottom: 5px;">PETGroom –ê–ª–º–∞—Ç—ã</h2>
        <p style="color: #999; margin-bottom: 30px;">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å</p>

        <button class="btn client" onclick="location.href='client.html'">üêæ –Ø –ø—Ä–∏–≤–µ–ª –ø–∏—Ç–æ–º—Ü–∞</button>
        <button class="btn master" onclick="regMaster()">‚úÇÔ∏è –Ø –º–∞—Å—Ç–µ—Ä (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä–Ω—ã
        const SUPABASE_URL = 'https://uplcrgnxkafcxejwuggx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SDlNlU_Nco34DHqTS0DasA_5jQqyiSF'; // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ANON PUBLIC KEY
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkRole() {
            try {
                const user = tg.initDataUnsafe.user;

                // –ï—Å–ª–∏ –∑–∞—à–ª–∏ –Ω–µ –∏–∑ Telegram (—Ç–µ—Å—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ) ‚Äî —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
                if (!user || !user.id) {
                    showMenu();
                    return;
                }

                // –ó–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ –º–∞—Å—Ç–µ—Ä–æ–≤
                const { data, error } = await _supabase
                    .from('masters')
                    .select('telegram_id')
                    .eq('telegram_id', user.id)
                    .maybeSingle();

                if (error) throw error;

                if (data) {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –º–∞—Å—Ç–µ—Ä
                    location.href = 'admin.html';
                } else {
                    // –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                    showMenu();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏:', err);
                // –í —Å–ª—É—á–∞–µ –ª—é–±–æ–π –æ—à–∏–±–∫–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ –±–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
                showMenu();
            }
        }

        function showMenu() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('menu').style.display = 'block';
        }

        function regMaster() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É
            tg.sendData(JSON.stringify({action: "start_master_registration"}));
            tg.close();
        }

        checkRole();
    </script>
</body>
</html>